<?phpclass Model_Capture extends Model{    public $page;    public function __construct($page = null)    {        $this->page = $page;    }    public function save($source, $email)    {        date_default_timezone_set('Europe/Kiev');        $data = base64_decode($source);        $msg = array();        $db = Db::getInstance();        $query = $db->prepare("SELECT id FROM users WHERE email = :username");        $query->execute(array(':username' => $email));        if ($query->rowCount() > 0) {            $result = $query->fetch(PDO::FETCH_ASSOC);            $i = 1;            while (True) {                if (file_exists("upload/userimage/" . $i . ".png"))                    $i++;                else                    break;            }            file_put_contents("upload/userimage/" . $i . ".png", $data);            $query = $db->prepare("INSERT INTO photos(name, created, user_id) VALUES(:name, now(), :id)");            $query->execute(array(':name' => $i . ".png", ':id' => $result['id']));            $query = $db->prepare('SELECT id FROM photos WHERE name = :name');            $query->execute(array(':name' => $i . '.png'));            $im = $query->fetch(PDO::FETCH_ASSOC);            $msg['name'] = $i . ".png";            $msg['id'] = $im['id'];        }        return $msg;    }    public function getmedia($email)    {        $db = Db::getInstance();        $query = $db->prepare("SELECT id FROM users WHERE email = :username");        $query->execute(array(':username' => $email));        if ($query->rowCount() > 0) {            $result = $query->fetch(PDO::FETCH_ASSOC);            $page = array();            $query = $db->prepare("SELECT name, id FROM photos WHERE user_id = :id ORDER BY created DESC");            $query->execute(array(':id' => $result['id']));            while ($img = $query->fetch(PDO::FETCH_ASSOC)) {                $query_likes = $db->prepare("SELECT id FROM likes WHERE photo_id = :id AND user_id = :u_id");                $query_likes->execute(array(':id' => $img['id'], ':u_id' => $result['id']));                if ($query_likes->rowCount() > 0)                    $is_liked = true;                else                    $is_liked = false;                $query_likes = $db->prepare("SELECT id FROM likes WHERE photo_id = :id");                $query_likes->execute(array(':id' => $img['id']));                $query_comments = $db->prepare("SELECT user_id, comment FROM comments WHERE photo_id = :id");                $query_comments->execute(array(':id' => $img['id']));                $comments = array();                while ($comment = $query_comments->fetch(PDO::FETCH_ASSOC)) {                    $query = $db->prepare("SELECT email, username FROM users WHERE id = :id");                    $query->execute(array(':id' => $comment['user_id']));                    $user = $query->fetch(PDO::FETCH_ASSOC);                    if (isset($user['username']) && $user['username'] != "")                        $username = $user['username'];                    else                        $username = $user['email'];                    $comnt = array();                    $comnt['username'] = $username;                    $comnt['comment'] = $comment['comment'];                    $comments[] = $comnt;                }                $imgdata = array();                $imgdata['id'] = $img['id'];                $imgdata['name'] = $img['name'];                $imgdata['liked'] = $is_liked;                $imgdata['likes'] = $query_likes->rowCount();                $imgdata['comments'] = $comments;                $page[] = $imgdata;            }            return $page;        } else {            return NULL;        }    }    public function comment($user, $id, $comment)    {        $db = Db::getInstance();        $query = $db->prepare("SELECT id, username FROM users WHERE email = :user");        $query->execute(array(':user' => $user));        $user = $query->fetch(PDO::FETCH_ASSOC);        $query = $db->prepare("INSERT INTO comments(photo_id, user_id, comment) VALUES(:photo_id, :user_id, :comment)");        $query->execute(array(':photo_id' => $id, ':user_id' => $user['id'], ':comment' => $comment));        return $user['username'];    }    public function like($user, $id)    {        $db = Db::getInstance();        $query = $db->prepare("SELECT id FROM users WHERE email = :user");        $query->execute(array(':user' => $user));        $user = $query->fetch(PDO::FETCH_ASSOC);        $query = $db->prepare("SELECT id FROM likes WHERE photo_id = :photo AND user_id = :user");        $query->execute(array(':photo' => $id, ':user' => $user['id']));        if ($query->rowCount() > 0) {            $query = $db->prepare("DELETE FROM likes WHERE photo_id = :photo AND user_id = :user");            $query->execute(array(':photo' => $id, ':user' => $user['id']));            return '0';        } else {            $query = $db->prepare("INSERT INTO likes (photo_id, user_id) VALUES (:photo_id, :user_id)");            $query->execute(array(':photo_id' => $id, ':user_id' => $user['id']));            return '1';        }    }    public function makemain($user, $id)    {        $db = Db::getInstance();        $query = $db->prepare("SELECT id FROM users WHERE email = :user");        $query->execute(array(':user' => $user));        $user = $query->fetch(PDO::FETCH_ASSOC);        $query = $db->prepare("SELECT name FROM photos WHERE id = :photo");        $query->execute(array(':photo' => $id));        $photo = $query->fetch(PDO::FETCH_ASSOC);        $query = $db->prepare("UPDATE users SET userpic = :pic WHERE id = :id");        $query->execute(array(':pic' => $photo['name'], ':id' => $user['id']));        return 1;    }}